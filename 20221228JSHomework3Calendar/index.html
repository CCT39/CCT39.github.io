<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link rel="stylesheet" href="./reset.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <!-- Until: 2022.12.31 15:16 ~9hrs -->
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 w-100 px-0">
                <table class="table table-info table-bordered border-primary w-100">
                    <caption align="top">
                        <div id="prev"><i class="fa-sharp fa-solid fa-caret-left"></i></div>
                            <h1 class="col-12 text-center my-2 py-2 position-relative">
                                羅馬人的日曆
                                <!-- <sup><i class="fa-solid fa-circle-info position-absolute"></i></sup> -->
                                <br><span class="spqr">Calendarium Populumque Romanum</span>
                            </h1>
                            <p class="text-center"><span class="fs-1" id="year"></span>
                                <span class="fs-3" id="month"></span></p>
                        <div id="post"><i class="fa-sharp fa-solid fa-caret-right"></i></div>
                    </caption>
                    <thead>
                        <tr class="w-100 fs-5 text-center">
                            <th> <strong>Sun</strong><br><span class="spqr">dies Solis</span></th>
                            <th> <strong>Mon</strong><br><span class="spqr">dies Lunae</span></th>
                            <th> <strong>Tue</strong><br><span class="spqr">dies Martis</span></th>
                            <th> <strong>Wed</strong><br><span class="spqr">dies Mercurii</span></th>
                            <th> <strong>Thu</strong><br><span class="spqr">dies Iovis</span></th>
                            <th> <strong>Fri</strong><br><span class="spqr">dies Veneris</span></th>
                            <th> <strong>Sat</strong><br><span class="spqr">dies Saturni</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="w-100">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr class="w-100">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr class="w-100">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr class="w-100">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr class="w-100">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr class="w-100">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="modal fade" id="window-for-schedules" tabindex="-1" aria-labelledby="schedule-list" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="schedule-list">Modal title</h2>
                    <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-schedule">新增行程</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="add-schedule" tabindex="-1" aria-labelledby="add-new-event" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="add-new-event">新增行程</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="schedule-title" class="d-block my-3"><input type="text" name="title" id="schedule-title" placeholder="新增標題" class="w-100 border-0"></label>
                    <label for="begin-time" class="d-inline-block m-2">起始時間：<input type="time" name="start" id="begin-time"></label>
                    <label for="end-time" class="d-inline-block m-2">結束時間：<input type="time" name="end" id="end-time"></label>
                    <label for="schedule-content" class="d-block my-3"> <input type="textarea" name="description" id="schedule-content" placeholder="行程描述" class="w-100"> </label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">離開</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">儲存變更</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
    <script>
        const currentFullDate = new Date();
        const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        const daysOfMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        // date = new Date();
        // date 取得完整時間 e.g. Sat Dec 31 2022 15:47:03 GMT+0800 (台北標準時間)
        // date.getDay() 取得星期（0-6，週日 = 0）
        // date.getFullYear() 取得4位數字西元年
        // date.getMonth() 取得月份（0-11）
        // date.getDate() 取得日（1-31）
        let currentYear, currentMonth, currentDate, currentWeekday;
        let tbody, allTds, displayYear, displayMonth, btnPrev, btnPost;
        let windowForSchedule, btnAddSchedule, windowAddSchedule, titleScheduleList, closeScheduleList;
        let trArr = [], currDayOfMonthArr = [];
        
        window.onload = () => {
            getElements();
            initVariables();
            setEventListeners();
            initTable();
        }
        function getElements(){
            tbody = document.querySelector('tbody');
            allTds = document.querySelectorAll('td');
            displayYear = document.getElementById('year');
            displayMonth = document.getElementById('month');
            btnPrev = document.getElementById('prev');
            btnPost = document.getElementById('post');
            windowForSchedule = document.getElementById('window-for-schedules');
            windowAddSchedule = document.getElementById('add-schedule');
            btnAddSchedule = windowForSchedule.querySelector('[data-bs-target="#add-schedule"]');
            closeScheduleList = windowForSchedule.querySelector('[data-bs-dismiss="modal"]');
            titleScheduleList = document.getElementById('schedule-list');
        }
        function initVariables(){
            currentYear = currentFullDate.getFullYear();
            currentMonth = currentFullDate.getMonth();
            currentDate = currentFullDate.getDate();
            currentWeekday = currentFullDate.getDay();
        }
        function setEventListeners(){
            btnPrev.addEventListener('click', () => { moveMonth(false); })
            btnPost.addEventListener('click', () => { moveMonth(true); })
            allTds.forEach(td => { td.addEventListener('click', () => {
                let dataDate = td.dataset.date;
                console.log(dataDate);
                let ymdArr = dataDate.split('-');
                let titleText = `西元${ymdArr[0]}年${parseInt(ymdArr[1]) + 1}月${ymdArr[2]}日的行程`;

                if (dataDate.includes('BC')){ 
                    titleText = `西元前${ymdArr[0].replace('BC', '')}年${parseInt(ymdArr[1]) + 1}月${ymdArr[2]}日的行程`;
                }

                titleScheduleList.innerHTML = titleText;
                btnAddSchedule.id = dataDate;
            })})
            closeScheduleList.addEventListener('click', () => { btnAddSchedule.removeAttribute('id'); })
            btnAddSchedule.addEventListener('click', () => {
                let thisDate = btnAddSchedule.id;
            })

        }
        function initTable(){
            document.querySelectorAll('.spqr').forEach(x => { x.innerHTML = x.innerHTML.replaceAll('u', 'v').replaceAll('ae', 'ӕ').replaceAll('j', 'i').replaceAll('w', 'v'); })
            checkLeapYear();
            setThisMonth();
        }

        function moveMonth(isForward){
            let step = 1;
            if (isForward == false){ step = -1; }

            currentMonth += step;
            checkMonthOverflow();
            setThisMonth();
        }

        function checkMonthOverflow(){
            if (currentMonth >= 0 && currentMonth <= 11){ return; }

            let yearCarry = 1;
            if (currentMonth < 0){ yearCarry = -1; }

            currentMonth = currentMonth - (12 * yearCarry); 
            currentYear += yearCarry;

            checkLeapYear();
        }

        function checkLeapYear(){
            currDayOfMonthArr = daysOfMonth;

            let beginningDate = new Date(currentYear, 01, 01);
            let endingDate = new Date(currentYear, 12, 31);
            if (beginningDate.getDay() != endingDate.getDay()){ currDayOfMonthArr[1] = 29; } 
            else { currDayOfMonthArr[1] = 28; }
        }

        function setThisMonth(){

            const clearThisMonth = () => {
                allTds.forEach(x => { 
                    x.removeAttribute('data-date');
                    x.removeAttribute('data-bs-toggle');
                    x.removeAttribute('data-bs-target');
                    x.classList.remove('disabled-cell'); 
                    x.innerHTML = '';
                })
            }
            const showTextsOnCells = () => {
                let firstDay = new Date(currentYear, currentMonth, 01);
                while(Math.abs(currentYear) > 9999){ currentYear %= 10000; }
                let monthIn2Digits = currentMonth.toString().padStart(2, '0');
                let yearIn4Digits = currentYear.toString().padStart(4, '0');
                if(currentYear < 1){ yearIn4Digits = 'BC' + Math.abs(currentYear - 1).toString().padStart(4, '0'); }

                for(let i = 0; i < currDayOfMonthArr[currentMonth]; i++){
                    let index = firstDay.getDay() + i;
                    let targetCell = allTds[index];
                    let dateIn2Digits = (i + 1).toString().padStart(2, '0');

                    targetCell.innerHTML = `<p class="text-center fw-bold">${dateIn2Digits}</p>`;
                    targetCell.setAttribute('data-date', `${yearIn4Digits}-${monthIn2Digits}-${dateIn2Digits}`);
                }
            }
            const setAttributesOfCells = () => {
                allTds.forEach(x => {
                    if (x.dataset.date == null){ x.classList.add('disabled-cell'); }
                    else{
                        x.setAttribute("data-bs-toggle", "modal");
                        x.setAttribute("data-bs-target", "#window-for-schedules");
                    }
                });
            }
            const displayYearAndMonthOnTitle = () => {
                let thisYear = currentYear;
                if (currentYear < 1){ thisYear = currentYear - 1; }
                displayYear.innerHTML = thisYear;
                displayMonth.innerHTML = months[currentMonth];
            }

            clearThisMonth();
            showTextsOnCells();
            setAttributesOfCells();
            displayYearAndMonthOnTitle();
        }
    </script>
</body>
</html>